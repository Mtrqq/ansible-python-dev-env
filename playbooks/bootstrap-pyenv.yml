---
- name: Bootstrap pyenv
  hosts: all
  tasks:
    - name: Install python build dependencies
      apt:
        name:
        - build-essential
        - libssl-dev
        - zlib1g-dev
        - libbz2-dev
        - libreadline-dev
        - libsqlite3-dev
        - wget
        - curl
        - llvm
        - libncurses5-dev
        - libncursesw5-dev
        - xz-utils
        - tk-dev
        - libffi-dev
        - liblzma-dev
        - python-openssl
        - git
        state: present
        autoclean: yes
        autoremove: yes

    - name: Setup pyenv
      ansible.builtin.shell: |
        HEADING="Pyenv exports"
        for rc_file in ~/.profile ~/.zshrc ~/.bashrc; do
          if test -f "$rc_file" && ! grep -q "$HEADING" "$rc_file"; then
            echo '\n' >> "$rc_file"
            echo "#${HEADING}" >> "$rc_file"
            curl -L https://github.com/pyenv/pyenv-installer/raw/master/bin/pyenv-installer | bash
            echo 'export PYENV_ROOT="$HOME/.pyenv"' >> "$rc_file"
            echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> "$rc_file"
            echo 'eval "$(pyenv init --path)"' >> "$rc_file"
            echo 'eval "$(pyenv virtualenv-init -)"' >> "$rc_file"
            echo '\n' >> "$rc_file"
          fi
        done

    - name: Install python versions
      ansible.builtin.shell: |
        pyenv install {{ item }} --skip-existing
      with_items:
        - 3.7.8
        - 3.8.9
        - 3.9.4
